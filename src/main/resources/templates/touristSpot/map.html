<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관광지 지도</title>
    <link rel="stylesheet" href="/css/map.css">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9795bab39c2cc262f3aec7f26ec16196&libraries=services,drawing"></script>
</head>
<body>

<!-- Header Section -->
<header class="navbar">
    <div class="logo">
        <a href="/">
            <img src="/images/logo.png" class="logo img">
            <span>MODUNURI</span>
        </a>
    </div>
    <nav>
        <ul class="nav-links">
            <li><a href="/users/mypage">My Page</a></li>
            <li><a href="/users/logout">Logout</a></li>
        </ul>
    </nav>
</header>

<!-- Main Container -->
<div class="container">
    <!-- Left Panel for Tour List -->
    <div class="tour-list">
        <h2>내 저장 목록</h2>
        <div id="saved-places" class="saved-places drop-area" ondrop="drop(event)" ondragover="allowDrop(event)">
            <!-- 저장된 관광지 박스가 여기에 추가됩니다. -->
        </div>

        <div class="days">
            <div id="day1" class="day">
                <h3>1일차</h3>
                <div class="drop-area" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <!-- 관광지를 드롭할 수 있는 공간 -->
                </div>
            </div>
            <button onclick="addDay()">일차 추가</button>
        </div>
    </div>

    <!-- Right Panel for Map -->
    <div id="map" style="width: 70%; height: 600px;"></div>
</div>

<!-- Modal for Search Result -->
<div id="search-result-modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>관광지 정보</h3>
        <div id="place-info"></div>
        <button id="saveButton">저장하기</button>
    </div>
</div>

<!-- Footer Section -->
<footer class="footer">
    <p>&copy; 2024 MODUNURI</p>
</footer>

<script>
    var mapContainer = document.getElementById('map'), // 지도 표시할 div
        mapOption = {
            center: new kakao.maps.LatLng(33.450701, 126.570667), // 기본 중심 좌표
            level: 8 // 확대 레벨
        };

    var map = new kakao.maps.Map(mapContainer, mapOption); // 지도 생성

    var dayRoutes = {}; // 일차별 경로를 저장할 객체
    var routeColors = {}; // 일차별 색상 저장
    var favoritePlaces = {}; // 저장된 관심 관광지 정보 저장 객체

    // 저장된 관광지 목록 불러오기
    function loadSavedPlaces() {
        fetch('/users/getFavoriteContents')
            .then(response => response.json())
            .then(favoritePlacesData => {
                favoritePlaces = favoritePlacesData; // 데이터를 전역변수에 저장
                Object.keys(favoritePlaces).forEach(contentId => {
                    const contentTypeId = favoritePlaces[contentId];  // contentTypeId를 함께 가져옴

                    // contentId와 contentTypeId를 사용해 관광지 정보 가져오기
                    fetch(`/touristSpot/Json/tourist-information?contentId=${contentId}&contentTypeId=${contentTypeId}`)
                        .then(response => response.json())
                        .then(data => {
                            displaySavedPlace(data.touristDetail);  // 관광지 정보를 UI에 표시하는 함수 호출
                        })
                        .catch(error => console.error("Error fetching tourist information:", error));
                });
            })
            .catch(error => {
                console.error('Error loading saved places:', error);
            });
    }

    // 저장된 관광지 정보를 박스로 표시
    function displaySavedPlace(touristDetail) {
        const savedPlaces = document.querySelector('#saved-places');

        // 관광지 박스 생성
        const placeBox = document.createElement('div');
        placeBox.classList.add('place-box');
        placeBox.setAttribute('draggable', 'true');
        placeBox.setAttribute('ondragstart', 'drag(event)');
        placeBox.id = `place-${touristDetail.contentid}`;

        // 이미지와 텍스트 추가
        const imageUrl = touristDetail.firstimage || '/images/placeholder.png';  // 이미지가 없을 때 대체 이미지 사용
        const title = touristDetail.title || "제목 없음";
        const address = touristDetail.addr1 || "주소 없음";

        placeBox.innerHTML = `
        <div class="place-info">
            <img src="${imageUrl}" alt="${title}" class="place-image" />
            <div class="place-text">
                <h4>${title}</h4>
                <p>${address}</p>
            </div>
        </div>
    `;

        // 관광지 목록에 추가
        savedPlaces.appendChild(placeBox);
    }

    // 마커 추가 및 경로 그리기
    function addMarkerAndRoute(touristDetail, day) {
        const coords = new kakao.maps.LatLng(touristDetail.mapy, touristDetail.mapx);

        // 마커 생성
        const marker = new kakao.maps.Marker({
            map: map,
            position: coords
        });

        // 인포윈도우 생성
        var infowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px;">${touristDetail.title}</div>` // 관광지 이름 표시
        });

        // 마커에 인포윈도우 표시
        infowindow.open(map, marker);

        // 일차별 경로 관리
        if (!dayRoutes[day]) {
            dayRoutes[day] = [];
            routeColors[day] = getRandomColor();  // 일차별 색상 설정
        }

        dayRoutes[day].push(coords);  // 해당 일차에 좌표 추가

        // 경로를 그리기 위해 모든 일차의 경로를 다시 그립니다.
        Object.keys(dayRoutes).forEach(dayKey => {
            const linePath = dayRoutes[dayKey].map(coord => coord);
            const polyline = new kakao.maps.Polyline({
                path: linePath,
                strokeWeight: 5,
                strokeColor: routeColors[dayKey], // 일차별로 설정된 색상 사용
                strokeOpacity: 0.7,
                strokeStyle: 'solid'
            });
            polyline.setMap(map);  // 지도에 경로 그리기
        });
    }

    // 드래그 앤 드롭 기능
    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.id);
    }

    function drop(ev) {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("text");
        var targetContainer = ev.target;

        // 드롭할 수 있는 영역인지 확인
        if (targetContainer.classList.contains('drop-area')) {
            targetContainer.appendChild(document.getElementById(data));

            // 일차에 드롭된 경우 마커 및 경로 추가
            const day = targetContainer.closest('.day').id;
            const placeId = data.split('-')[1];  // place-1234 형식에서 id만 추출

            fetch(`/touristSpot/Json/tourist-information?contentId=${placeId}&contentTypeId=${favoritePlaces[placeId]}`)
                .then(response => response.json())
                .then(data => {
                    addMarkerAndRoute(data.touristDetail, day);  // 마커 및 경로 추가
                });
        }
    }

    // 랜덤 색상 생성 함수
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    // 일차 추가 기능
    var dayCount = 1;
    function addDay() {
        dayCount++;
        var dayDiv = document.createElement("div");
        dayDiv.id = "day" + dayCount;
        dayDiv.className = "day";
        dayDiv.innerHTML = `<h3>${dayCount}일차</h3><div class="drop-area" ondrop="drop(event)" ondragover="allowDrop(event)"></div>`;
        document.querySelector('.days').appendChild(dayDiv);
    }

    // 페이지 로드 시 저장된 관광지 목록 불러오기
    document.addEventListener('DOMContentLoaded', function () {
        loadSavedPlaces();
    });

    // 모달 닫기 기능
    function closeModal() {
        document.getElementById('search-result-modal').style.display = "none";
    }
</script>

</body>
</html>
